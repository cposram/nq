<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°è‚¡æ—¥ç›¤åœ‹éš›æŒ‡æ•¸ç›£æ§</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px; }
        .card { background: #2d2d2d; padding: 15px; border-radius: 10px; border: 1px solid #444; }
        .price { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .change { font-size: 18px; }
        .up { color: #ff4d4d; } /* é…åˆå°è‚¡ç¿’æ…£ï¼Œç´…æ¼²ç¶ è·Œ */
        .down { color: #00ff00; }
        .log { text-align: left; max-width: 600px; margin: 20px auto; background: #000; padding: 10px; font-family: monospace; height: 150px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>å°è‚¡ç›¤ä¸­æˆ°æƒ…å®¤</h1>
    <div id="status">ç³»çµ±æª¢æŸ¥ä¸­...</div>
    <div class="grid" id="dashboard"></div>
    <div class="log" id="log">ç³»çµ±æ—¥èªŒï¼š<br></div>

    <script>
        // --- è¨­å®šå€ ---
        const TWELVE_DATA_API_KEY = '0227846f1dd54d49973171d9bcd91a27';
        const PUSHBULLET_TOKEN = 'ä½ çš„_PUSHBULLET_ACCESS_TOKEN';
        const USER_EMAIL = 'cposram@gmail.com';
        
        // è¿½è¹¤æ¸…å–® (ä»£è™Ÿéœ€ç¬¦åˆ Twelve Data æ ¼å¼)
        const symbols = [
            { id: 'NQ=F', name: 'å°é‚£æ–¯é”å…‹', type: 'future' },
            { id: 'ES=F', name: 'å°æ¨™æ™®', type: 'future' },
            { id: 'TSM', name: 'å°ç©é›» ADR', type: 'stock' },
            { id: 'NI225', name: 'æ—¥ç¶“ 225', type: 'index' },
            { id: 'KS11', name: 'éŸ“åœ‹ç¶œåˆ', type: 'index' },
            { id: 'EWT', name: 'å¯Œå°æŒ‡/å°è‚¡ETF', type: 'etf' }
        ];

        let lastPrices = {};

        async function fetchData() {
            document.getElementById('status').innerText = "æ›´æ–°æ™‚é–“: " + new Date().toLocaleTimeString();
            
            for (let item of symbols) {
                try {
                    const response = await fetch(`https://api.twelvedata.com/quote?symbol=${item.id}&apikey=${TWELVE_DATA_API_KEY}`);
                    const data = await response.json();
                    
                    if (data.symbol) {
                        updateUI(data, item.name);
                        checkAlerts(data, item.name);
                    }
                } catch (e) {
                    console.error("æŠ“å–å¤±æ•—", e);
                }
            }
        }

        function updateUI(data, name) {
            let container = document.getElementById('dashboard');
            let card = document.getElementById(`card-${data.symbol}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${data.symbol}`;
                card.className = 'card';
                container.appendChild(card);
            }
            
            const isUp = parseFloat(data.percent_change) >= 0;
            card.innerHTML = `
                <div>${name} (${data.symbol})</div>
                <div class="price">${parseFloat(data.close).toFixed(2)}</div>
                <div class="change ${isUp ? 'up' : 'down'}">${data.percent_change}%</div>
            `;
        }

        function checkAlerts(data, name) {
            const price = parseFloat(data.close);
            const dailyChange = parseFloat(data.percent_change);
            const symbol = data.symbol;

            // 1. è·Œå¹…è¶…é 1% è­¦å‘Š
            if (dailyChange <= -1.0) {
                sendNotification(`âš ï¸ é‡å¤§è·Œå‹¢ï¼š${name} è·Œå¹…é” ${dailyChange}%ï¼`);
            }

            // 2. ä¸€åˆ†é˜æ¼²è·Œå¹…æª¢æ¸¬ (å‡è¨­ 0.1% ç‚ºé–€æª»)
            if (lastPrices[symbol]) {
                const minuteChange = ((price - lastPrices[symbol]) / lastPrices[symbol]) * 100;
                if (Math.abs(minuteChange) >= 0.1) {
                    const direction = minuteChange > 0 ? "æ€¥æ‹‰" : "æ€¥æ®º";
                    sendNotification(`ğŸš€ ç•°å‹•ï¼š${name} 1åˆ†é˜å…§${direction} ${minuteChange.toFixed(2)}%`);
                }
            }
            lastPrices[symbol] = price;
        }

        function sendNotification(msg) {
            const log = document.getElementById('log');
            log.innerHTML += `[é€šçŸ¥å·²ç™¼é€] ${msg}<br>`;
            
            // Pushbullet API æ¨æ’­
            fetch('https://api.pushbullet.com/v2/pushes', {
                method: 'POST',
                headers: {
                    'Access-Token': PUSHBULLET_TOKEN,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'note',
                    title: 'å°è‚¡ç›¤ä¸­è­¦å ±',
                    body: msg,
                    email: USER_EMAIL // Pushbullet åŒæ™‚æœƒç™¼é€åˆ°æ­¤ Email
                })
            });
        }

        // æ¯ 60 ç§’åŸ·è¡Œä¸€æ¬¡
        setInterval(fetchData, 60000);
        fetchData(); // åˆå§‹åŸ·è¡Œ
    </script>
</body>
</html>
