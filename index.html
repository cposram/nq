<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>台股全能戰情室</title>
    <style>
        :root { --up: #ff4d4d; --down: #00ff00; --bg: #121212; --card: #1e1e1e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 20px; }
        
        /* 佈局：上方核心區大，下方參考區小 */
        .container { max-width: 1100px; margin: 0 auto; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #333; transition: 0.3s; }
        .main-card { border-left: 5px solid #555; }
        .main-card.active { border-left-color: #007bff; }
        
        .label { color: #888; font-size: 14px; margin-bottom: 8px; }
        .price { font-size: 32px; font-weight: bold; font-family: 'Consolas', monospace; }
        .sub-price { font-size: 22px; font-weight: bold; }
        .change { font-size: 20px; font-weight: bold; margin-top: 8px; }
        .up { color: var(--up); } .down { color: var(--down); }
        
        .status-bar { display: flex; justify-content: space-between; padding: 10px; font-size: 12px; color: #666; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; margin-left: 5px; }
        .log-box { background: #000; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; color: #00ff00; height: 100px; overflow-y: auto; margin-top: 20px; border: 1px solid #222; }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <span id="update-time">初始化中...</span>
            <span>API 消耗: 1 Token/min | <a href="#" onclick="clearKeys()" style="color:#666">重設金鑰</a></span>
        </div>

        <h3 style="text-align:left; margin-left:10px;">核心指標 (台股連動權重 80%+)</h3>
        <div class="main-grid" id="main-display">
            </div>

        <h3 style="text-align:left; margin-left:10px; font-size:16px; color:#888;">輔助參考 (區域性與大盤情緒)</h3>
        <div class="sub-grid" id="sub-display">
            </div>

        <div class="log-box" id="log">系統啟動...</div>
    </div>

    <script>
        const TD_KEY = localStorage.getItem('td_key') || prompt("輸入 Twelve Data API Key:");
        const PB_TOKEN = localStorage.getItem('pb_token') || prompt("輸入 Pushbullet Token:");
        if(TD_KEY && PB_TOKEN) { localStorage.setItem('td_key', TD_KEY); localStorage.setItem('pb_token', PB_TOKEN); }

        const coreIcons = ['QQQ', 'EWT']; // 核心
        const allSymbols = [
            { id: 'QQQ', name: '小那斯達克 (QQQ)', isCore: true },
            { id: 'EWT', name: '富台指 (EWT)', isCore: true },
            { id: 'SPY', name: '小標普 (SPY)', isCore: false },
            { id: 'EWJ', name: '日經 225 (EWJ)', isCore: false },
            { id: 'EWY', name: '韓國綜合 (EWY)', isCore: false },
            { id: 'TSM', name: '台積電 ADR (TSM)', isCore: false }
        ];

        let lastPrices = {};

        async function fetchAll() {
            const list = allSymbols.map(s => s.id).join(',');
            const url = `https://api.twelvedata.com/quote?symbol=${list}&apikey=${TD_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                document.getElementById('update-time').innerText = "最後更新: " + new Date().toLocaleTimeString();
                
                allSymbols.forEach(sym => {
                    const result = data[sym.id] || data;
                    if(result && result.close) {
                        updateUI(result, sym);
                        checkAlerts(result, sym);
                    }
                });
            } catch (e) { console.error(e); }
        }

        function updateUI(data, info) {
            const container = info.isCore ? document.getElementById('main-display') : document.getElementById('sub-display');
            let card = document.getElementById(`card-${data.symbol}`);
            
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${data.symbol}`;
                card.className = info.isCore ? 'card main-card active' : 'card';
                container.appendChild(card);
            }

            const change = parseFloat(data.percent_change) || 0;
            const color = change >= 0 ? 'up' : 'down';
            
            // 判斷是否為「靜態參考」(美股盤中時間外)
            const isStatic = (data.symbol === 'TSM' || data.symbol === 'QQQ') && (new Date().getHours() >= 5 && new Date().getHours() < 20);

            card.innerHTML = `
                <div class="label">${info.name} ${isStatic ? '<span class="tag">參考昨收</span>' : '<span class="tag" style="background:#ad1457">即時</span>'}</div>
                <div class="${info.isCore ? 'price' : 'sub-price'}">${parseFloat(data.close).toFixed(2)}</div>
                <div class="change ${color}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
            `;
        }

        function checkAlerts(data, info) {
            const price = parseFloat(data.close);
            const change = parseFloat(data.percent_change);
            // 1. 跌幅警報
            if (change <= -1.0) sendNotify(`⚠️ ${info.name} 重挫 ${change}%`);
            // 2. 異動警報 (0.15%)
            if (lastPrices[data.symbol]) {
                const diff = ((price - lastPrices[data.symbol]) / lastPrices[data.symbol]) * 100;
                if (Math.abs(diff) >= 0.15) sendNotify(`⚡ ${info.name} ${diff > 0 ? '急拉' : '急跌'} ${diff.toFixed(2)}%`);
            }
            lastPrices[data.symbol] = price;
        }

        function sendNotify(msg) {
            document.getElementById('log').innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + document.getElementById('log').innerHTML;
            fetch('https://api.pushbullet.com/v2/pushes', {
                method: 'POST',
                headers: { 'Access-Token': PB_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'note', title: '台股監控', body: msg, email: 'cposram@gmail.com' })
            });
        }

        function clearKeys() { localStorage.clear(); location.reload(); }

        setInterval(fetchAll, 60000);
        fetchAll();
    </script>
</body>
</html>
