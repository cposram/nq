<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°è‚¡åˆ†å±¤ç›£æ§çœ‹æ¿ - ä¿®å¾©ç‰ˆ</title>
    <style>
        :root { --up: #ff4d4d; --down: #00ff00; --bg: #0d0d0d; --card: #1a1a1a; --accent: #00a2ff; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .section-title { font-size: 15px; color: #888; margin: 25px 0 10px 0; padding-left: 10px; border-left: 4px solid #444; }
        .level1-title { color: var(--accent); border-color: var(--accent); }
        .grid { display: grid; gap: 15px; margin-bottom: 25px; }
        .l1-grid { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        .l2-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .l3-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { background: var(--card); border-radius: 10px; padding: 20px; border: 1px solid #333; }
        .l1-card { border-top: 3px solid var(--accent); }
        .label { color: #aaa; font-size: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .price { font-size: 36px; font-weight: bold; font-family: 'Consolas', monospace; }
        .change { font-size: 20px; font-weight: bold; margin-top: 10px; }
        .up { color: var(--up); } .down { color: var(--down); }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; }
        .live { background: #ad1457; }
        .log-box { background: #000; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; color: #00ff00; height: 100px; overflow-y: auto; border: 1px solid #222; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <h2 style="margin:0;">ğŸ“Š å°è‚¡æˆ°æƒ…å®¤ <small style="font-size:12px; color:#666;">Dali Terminal</small></h2>
            <div id="status" style="font-size:12px; color:#888;">é€£ç·šä¸­...</div>
        </div>

        <div class="section-title level1-title">LEVEL 1: æ ¸å¿ƒå‹•æ…‹ (æ¯åˆ†é˜æ›´æ–°)</div>
        <div class="grid l1-grid" id="level1-display"></div>

        <div class="section-title">LEVEL 2: å€åŸŸæµå‘ (æ¯ 5 åˆ†é˜æ›´æ–°)</div>
        <div class="grid l2-grid" id="level2-display"></div>

        <div class="section-title">LEVEL 3: éœæ…‹å­˜æª” (ä¸æ¶ˆè€— Token)</div>
        <div class="grid l3-grid" id="level3-display"></div>

        <div class="log-box" id="log-box">ç³»çµ±æ—¥èªŒï¼šç­‰å¾… API éŸ¿æ‡‰...<br></div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const API_KEY = '0227846f1dd54d49973171d9bcd91a27';
        const PB_TOKEN = 'è«‹å¡«å…¥ä½ çš„PB_TOKEN'; // ç‚ºäº†å®‰å…¨å»ºè­°æ‰‹å‹•å¡«å…¥ä¸€æ¬¡
        
        const CONFIG = {
            level1: [ { id: 'NQ', name: 'å°é‚£æœŸè²¨' }, { id: 'EWT', name: 'å¯Œå°æŒ‡' }, { id: 'USD/TWD', name: 'å°å¹£åŒ¯ç‡' } ],
            level2: [ { id: 'NI225', name: 'æ—¥ç¶“ 225' }, { id: 'KS11', name: 'éŸ“åœ‹ç¶œåˆ' } ],
            level3: [ { id: 'TSM', name: 'å°ç©é›» ADR' }, { id: 'QQQ', name: 'é‚£æŒ‡æ˜¨æ”¶' } ]
        };

        let lastPrices = {};

        // é€šç”¨çš„æŠ“å–èˆ‡æ¸²æŸ“å‡½å¼
        async function updateMarketData(level) {
            const symbols = CONFIG[level].map(s => s.id).join(',');
            const url = `https://api.twelvedata.com/quote?symbol=${symbols}&apikey=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                CONFIG[level].forEach(item => {
                    const result = data[item.id] || data;
                    if (result && result.close) {
                        renderCard(result, item.name, level);
                        if (level === 'level1') checkAlerts(result, item.name);
                    }
                });
                document.getElementById('status').innerText = `æœ€å¾ŒåŒæ­¥: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                addLog(`[éŒ¯èª¤] ${level} æŠ“å–å¤±æ•—: ${e.message}`);
            }
        }

        function renderCard(data, displayName, level) {
            const containerId = `${level}-display`;
            const container = document.getElementById(containerId);
            if (!container) return; // é˜²æ­¢ appendChild åˆ° null

            let card = document.getElementById(`card-${data.symbol}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${data.symbol}`;
                card.className = `card ${level === 'level1' ? 'l1-card' : ''}`;
                container.appendChild(card);
            }

            const change = parseFloat(data.percent_change) || 0;
            const color = change >= 0 ? 'up' : 'down';
            card.innerHTML = `
                <div class="label">${displayName} <span class="tag ${level !== 'level3' ? 'live' : ''}">${level !== 'level3' ? 'LIVE' : 'REF'}</span></div>
                <div class="price">${parseFloat(data.close).toFixed(data.symbol.includes('TWD') ? 3 : 2)}</div>
                <div class="change ${color}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
            `;
        }

        function checkAlerts(data, name) {
            const price = parseFloat(data.close);
            if (lastPrices[data.symbol]) {
                const diff = ((price - lastPrices[data.symbol]) / lastPrices[data.symbol]) * 100;
                if (Math.abs(diff) >= 0.12) {
                    sendPush(`âš¡ ${name} ${diff > 0 ? 'æ€¥æ‹‰' : 'æ€¥æ®º'} ${diff.toFixed(2)}%`);
                }
            }
            lastPrices[data.symbol] = price;
        }

        function sendPush(msg) {
            addLog(`[ç™¼é€é€šçŸ¥] ${msg}`);
            if (PB_TOKEN.length < 5) return;
            fetch('https://api.pushbullet.com/v2/pushes', {
                method: 'POST',
                headers: { 'Access-Token': PB_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'note', title: 'å°è‚¡ç›£æ§', body: msg, email: 'cposram@gmail.com' })
            });
        }

        function addLog(msg) {
            const box = document.getElementById('log-box');
            box.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + box.innerHTML;
        }

        // --- å•Ÿå‹•é‚è¼¯ ---
        window.onload = () => {
            updateMarketData('level1');
            updateMarketData('level2');
            updateMarketData('level3');

            // åˆ†é »ç‡æ›´æ–°
            setInterval(() => updateMarketData('level1'), 60000);  // 1åˆ†é˜
            setInterval(() => updateMarketData('level2'), 300000); // 5åˆ†é˜
        };
    </script>
</body>
</html>
