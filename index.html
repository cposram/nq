<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°è‚¡ç›¤ä¸­ç²¾ç°¡ç›£æ§ (çœéŒ¢ç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; max-width: 1000px; margin: 20px auto; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .name { font-size: 16px; color: #aaa; margin-bottom: 8px; }
        .price { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .change { font-size: 18px; font-weight: 600; }
        .up { color: #ff4d4d; } /* ç´…æ¼² */
        .down { color: #00ff00; } /* ç¶ è·Œ */
        .log-box { text-align: left; max-width: 1000px; margin: 20px auto; background: #000; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; color: #00ff00; height: 120px; overflow-y: auto; border: 1px solid #444; }
        button { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #444; }
    </style>
</head>
<body>
    <h2>ğŸš€ å°è‚¡ç›¤ä¸­æˆ°æƒ…å®¤ (ç²¾ç°¡ç‰ˆ)</h2>
    <div id="status" style="font-size: 14px; color: #888;">æ­£åœ¨åˆå§‹åŒ–...</div>
    
    <div class="grid" id="dashboard">
        </div>

    <div class="log-box" id="log">ç³»çµ±ç‹€æ…‹ï¼šç­‰å¾… API é‡‘é‘°è¼¸å…¥...<br></div>
    <button onclick="clearKeys()">é‡æ–°è¨­å®š API Key</button>

    <script>
        // --- è¨­å®šå€ ---
        // ä½¿ç”¨ Prompt é¿å… Key ä¸Šå‚³ GitHub
        const TD_KEY = localStorage.getItem('0227846f1dd54d49973171d9bcd91a27') || prompt("è«‹è¼¸å…¥ Twelve Data API Key:");
        const PB_TOKEN = localStorage.getItem('pb_token') || prompt("è«‹è¼¸å…¥ Pushbullet Access Token:");

        if (TD_KEY && PB_TOKEN) {
            localStorage.setItem('td_key', TD_KEY);
            localStorage.setItem('pb_token', PB_TOKEN);
        }

        // è¿½è¹¤æ¸…å–® (ç²¾ç°¡ä»£ç¢¼ï¼Œç§»é™¤ TSM)
        const symbols = [
            { id: 'NQ', name: 'å°é‚£æ–¯é”å…‹ (æœŸè²¨)', type: 'future' },
            { id: 'ES', name: 'å°æ¨™æ™® (æœŸè²¨)', type: 'future' },
            { id: 'NI225', name: 'æ—¥ç¶“ 225', type: 'index' },
            { id: 'KS11', name: 'éŸ“åœ‹ç¶œåˆ', type: 'index' },
            { id: 'EWT', name: 'å¯Œå°æŒ‡/MSCIå°ç£', type: 'etf' }
        ];

        let lastPrices = {};

        async function updateData() {
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('log');
            const symbolList = symbols.map(s => s.id).join(',');
            
            try {
                // æ‰¹æ¬¡æŠ“å–ï¼šä¸€åˆ†é˜åªç”¨ 1 å€‹ token
                const url = `https://api.twelvedata.com/quote?symbol=${symbolList}&apikey=${TD_KEY}`;
                const response = await fetch(url);
                const results = await response.json();

                statusEl.innerText = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString()}`;

                symbols.forEach(item => {
                    const data = results[item.id];
                    if (data && data.close) {
                        renderCard(data, item.name);
                        checkAlerts(data, item.name);
                    } else {
                        logEl.innerHTML += `[éŒ¯èª¤] ç„¡æ³•ç²å– ${item.name} (${item.id}) è³‡æ–™<br>`;
                    }
                });
            } catch (e) {
                logEl.innerHTML += `[ç¶²è·¯éŒ¯èª¤] ${e.message}<br>`;
            }
        }

        function renderCard(data, displayName) {
            let container = document.getElementById('dashboard');
            let card = document.getElementById(`card-${data.symbol}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${data.symbol}`;
                card.className = 'card';
                container.appendChild(card);
            }

            const change = parseFloat(data.percent_change) || 0;
            const isUp = change >= 0;
            const colorClass = isUp ? 'up' : 'down';
            const prefix = isUp ? '+' : '';

            card.innerHTML = `
                <div class="name">${displayName}</div>
                <div class="price">${parseFloat(data.close).toLocaleString()}</div>
                <div class="change ${colorClass}">${prefix}${change.toFixed(2)}%</div>
            `;
        }

        function checkAlerts(data, name) {
            const price = parseFloat(data.close);
            const change = parseFloat(data.percent_change);
            const symbol = data.symbol;

            // 1. è·Œå¹…é–€æª»å‘Šè­¦ (1%)
            if (change <= -1.0) {
                sendPush(`âš ï¸ è­¦å ±ï¼š${name} è·Œå¹…æ“´å¤§è‡³ ${change}%ï¼`);
            }

            // 2. åŠ‡çƒˆæ³¢å‹•å‘Šè­¦ (èˆ‡å‰ä¸€æ¬¡æŠ“å–ç›¸æ¯”å·®ç•° > 0.15%)
            if (lastPrices[symbol]) {
                const diff = ((price - lastPrices[symbol]) / lastPrices[symbol]) * 100;
                if (Math.abs(diff) >= 0.15) {
                    const act = diff > 0 ? "æ€¥æ‹‰" : "æ€¥è·Œ";
                    sendPush(`âš¡ ç•°å‹•ï¼š${name} ${act} ${diff.toFixed(2)}%`);
                }
            }
            lastPrices[symbol] = price;
        }

        function sendPush(msg) {
            document.getElementById('log').innerHTML += `[é€šçŸ¥] ${msg}<br>`;
            
            fetch('https://api.pushbullet.com/v2/pushes', {
                method: 'POST',
                headers: {
                    'Access-Token': PB_TOKEN,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'note',
                    title: 'å°è‚¡ç›£æ§æé†’',
                    body: msg,
                    email: 'cposram@gmail.com'
                })
            });
        }

        function clearKeys() {
            localStorage.clear();
            location.reload();
        }

        // æ¯ 60 ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(updateData, 60000);
        updateData();
    </script>
</body>
</html>
