<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°è‚¡æˆ°æƒ…å®¤ | Dali Terminal å®‰å…¨ç‰ˆ</title>
    <style>
        :root { --up: #ff4d4d; --down: #00ff00; --bg: #0d0d0d; --card: #161616; --accent: #00a2ff; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .btn-group { display: flex; gap: 10px; }
        .btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .btn-test { background: #ad1457; }
        .btn-test:hover { background: #d81b60; }
        .btn-config { background: #444; }
        .btn-config:hover { background: #666; }
        .section-title { font-size: 14px; color: #666; margin: 20px 0 10px 0; padding-left: 10px; border-left: 4px solid #333; }
        .level1-title { color: var(--accent); border-color: var(--accent); }
        .grid { display: grid; gap: 15px; margin-bottom: 20px; }
        .l1-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .l2-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .l3-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid #222; }
        .l1-card { border-top: 3px solid var(--accent); background: #1a1a1a; }
        .label { color: #888; font-size: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .price { font-size: 38px; font-weight: bold; font-family: 'Consolas', monospace; }
        .change { font-size: 20px; font-weight: bold; margin-top: 8px; }
        .up { color: var(--up); } .down { color: var(--down); }
        .tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #333; }
        .live { background: #ad1457; color: white; }
        .log-box { background: #000; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; color: #00ff00; height: 110px; overflow-y: auto; border: 1px solid #222; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h2 style="margin:0;">ğŸ“Š å°è‚¡æˆ°æƒ…å®¤ <small style="font-size:12px; color:#555;">Dali Terminal</small></h2>
                <div id="status" style="font-size:11px; color:#888; margin-top:5px;">é€£ç·šç‹€æ…‹æª¢æŸ¥ä¸­...</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-config" onclick="setConfig()">âš™ï¸ è¨­å®š API</button>
                <button class="btn btn-test" onclick="testPush()">ğŸ”” æ¸¬è©¦æ¨æ’­</button>
            </div>
        </div>

        <div class="section-title level1-title">LEVEL 1: æ ¸å¿ƒå‹•æ…‹ (æ¯åˆ†é˜æ›´æ–°)</div>
        <div class="grid l1-grid" id="level1-display"></div>

        <div class="section-title">LEVEL 2: å€åŸŸæµå‘ (æ¯ 5 åˆ†é˜æ›´æ–°)</div>
        <div class="grid l2-grid" id="level2-display"></div>

        <div class="section-title">LEVEL 3: æ˜¨æ”¶åƒè€ƒ</div>
        <div class="grid l3-grid" id="level3-display"></div>

        <div class="log-box" id="log-box">ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚<br></div>
    </div>

    <script>
        // å›ºå®š Twelve Data Key (å¦‚ä½ æ‰€è¿°ï¼Œé€™å€‹æ²’é—œä¿‚)
        const TD_API_KEY = '0227846f1dd54d49973171d9bcd91a27';
        const EMAIL = 'cposram@gmail.com';

        // å¾ç€è¦½å™¨å¿«å–è®€å– PB Token
        let PB_TOKEN = localStorage.getItem('PB_TOKEN');

        const CONFIG = {
            level1: [ { id: 'NQ', name: 'å°é‚£æœŸè²¨' }, { id: 'TWN', name: 'å¯Œå°æŒ‡æ•¸' } ],
            level2: [ { id: 'NI225', name: 'æ—¥ç¶“ 225' }, { id: 'KS11', name: 'éŸ“åœ‹ç¶œåˆ' } ],
            level3: [ { id: 'TSM', name: 'å°ç©é›» ADR' }, { id: 'QQQ', name: 'é‚£æŒ‡æ˜¨æ”¶' } ]
        };

        let lastPrices = {};

        // è¨­å®š API Key çš„åŠŸèƒ½
        function setConfig() {
            const currentToken = localStorage.getItem('PB_TOKEN') || '';
            const newToken = prompt("è«‹è¼¸å…¥ä½ çš„ Pushbullet Access Token (ä¾‹å¦‚: o.xxx...):", currentToken);
            
            if (newToken !== null) {
                localStorage.setItem('PB_TOKEN', newToken.trim());
                PB_TOKEN = newToken.trim();
                addLog("API é‡‘é‘°å·²æ›´æ–°ä¸¦å„²å­˜è‡³ç€è¦½å™¨å¿«å–ã€‚");
                checkTokenStatus();
            }
        }

        function checkTokenStatus() {
            const statusEl = document.getElementById('status');
            if (!PB_TOKEN || PB_TOKEN.length < 5) {
                statusEl.innerHTML = "<span style='color:orange'>âš ï¸ å°šæœªè¨­å®š Pushbullet Tokenï¼Œè«‹é»æ“Šè¨­å®š</span>";
            } else {
                statusEl.innerHTML = "âœ… æ¨æ’­åŠŸèƒ½å·²é€£ç·š (" + PB_TOKEN.substring(0, 5) + "...)";
            }
        }

        function testPush() {
            if (!PB_TOKEN) {
                alert("è«‹å…ˆé»æ“Šè¨­å®šæŒ‰éˆ•è¼¸å…¥ Pushbullet Access Tokenï¼");
                return;
            }
            addLog("æ­£åœ¨å˜—è©¦ç™¼é€æ¸¬è©¦æ¨æ’­...");
            sendPush("ç³»çµ±é€šè¨Šæ¸¬è©¦æ­£å¸¸ï¼ç›®å‰çš„å°è‚¡ç›¤ä¸­ç›£æ§å·²é€£ç·šã€‚");
        }

        async function updateMarket(level) {
            const symbols = CONFIG[level].map(s => s.id).join(',');
            const url = `https://api.twelvedata.com/quote?symbol=${symbols}&apikey=${TD_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                CONFIG[level].forEach(item => {
                    const result = data[item.id] || data;
                    if (result && result.close) {
                        renderCard(result, item.name, level);
                        if (level === 'level1') checkAlerts(result, item.name);
                    }
                });
            } catch (e) {
                addLog(`[éŒ¯èª¤] ${level} è³‡æ–™æŠ“å–å¤±æ•—`);
            }
        }

        function renderCard(data, displayName, level) {
            const container = document.getElementById(`${level}-display`);
            if (!container) return;
            let card = document.getElementById(`card-${data.symbol}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${data.symbol}`;
                card.className = `card ${level === 'level1' ? 'l1-card' : ''}`;
                container.appendChild(card);
            }
            const change = parseFloat(data.percent_change) || 0;
            const color = change >= 0 ? 'up' : 'down';
            card.innerHTML = `
                <div class="label">${displayName} <span class="tag ${level !== 'level3' ? 'live' : ''}">${level !== 'level3' ? 'LIVE' : 'REF'}</span></div>
                <div class="price">${parseFloat(data.close).toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                <div class="change ${color}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
            `;
        }

        function checkAlerts(data, name) {
            const price = parseFloat(data.close);
            if (lastPrices[data.symbol]) {
                const diff = ((price - lastPrices[data.symbol]) / lastPrices[data.symbol]) * 100;
                if (Math.abs(diff) >= 0.1) {
                    sendPush(`âš¡ ${name} æ³¢å‹•ï¼š${diff > 0 ? 'æ€¥æ‹‰' : 'æ€¥æ®º'} ${diff.toFixed(2)}%`);
                }
            }
            lastPrices[data.symbol] = price;
        }

        function sendPush(msg) {
            if (!PB_TOKEN) return;
            fetch('https://api.pushbullet.com/v2/pushes', {
                method: 'POST',
                headers: { 'Access-Token': PB_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'note', title: 'å°è‚¡ç›£æ§å‘Šè­¦', body: msg, email: EMAIL })
            })
            .then(res => res.ok ? addLog("[æˆåŠŸ] æ¨æ’­å·²é€å‡º") : addLog("[å¤±æ•—] API éŸ¿æ‡‰éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Token"));
        }

        function addLog(msg) {
            const box = document.getElementById('log-box');
            box.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + box.innerHTML;
        }

        window.onload = () => {
            checkTokenStatus();
            updateMarket('level1');
            updateMarket('level2');
            updateMarket('level3');
            setInterval(() => updateMarket('level1'), 60000);
            setInterval(() => updateMarket('level2'), 300000);
        };
    </script>
</body>
</html>
